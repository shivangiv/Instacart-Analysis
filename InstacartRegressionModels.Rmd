---
title: "InstacartRegressionModels"
author: "Shivangi Vashi"
date: "5/29/2020"
output: html_document
---
<center>


### ALY 6040 Data Mining Applications
### Assignment 2: Instacart Linear and Logistic Regression Model
### Shivangi Vashi
### Yihong Qiu
### Md Tajrianul Islam

<br> <br> <br> <br>
<br> <br> <br> <br>
  
### Instructor: Kasun Samarasinghe
### Spring 2020
### May 29 2020
### Northeastern University
</center>

<br> <br> <br> <br>
<br> <br> <br> <br>
<br> <br> <br> <br>
<br> <br> <br> <br>
<br> <br> <br> <br>
<br> <br> <br> <br>

<style>
body {
text-align: justify}
</style>

<center>
$\LARGE Introduction$  </center>

This week we are

```{r}
library(plyr)
library(tidyverse)
library(data.table)
library(ggplot2)
library(ggcorrplot)

#using fread because it reads data very fast
aisles<-fread("instacart-market-basket-analysis/aisles.csv")
departments<-fread("instacart-market-basket-analysis/departments.csv")
order_products_prior<-fread("instacart-market-basket-analysis/order_products__prior.csv")
order_products_train<-fread("instacart-market-basket-analysis/order_products__train.csv")
orders<-fread("instacart-market-basket-analysis/orders.csv")
products<-fread("instacart-market-basket-analysis/products.csv")

head(orders)
head(order_products_prior)
head(order_products_train)
orders
dim(orders)
dim(order_products_prior)
summary(orders)
```


### Data Wrangling
```{r}


set.seed(1)
user_fraction <- 0.1
users <- unique(orders$user_id)
sample_users <- sample(users, round(user_fraction * length(users)))

cat('Number of orders (before): ', nrow(orders))
orders <- orders[user_id %in% sample_users]
cat('Number of orders (after): ', nrow(orders))
orders
unique(orders$user_id)


order_products_prior<-order_products_prior%>%semi_join(orders)
order_products_train<-order_products_train%>%semi_join(orders)
dim(order_products_prior)
dim(order_products_train)
```

### Predictors
```{r}
OrderProductPrior<-orders%>%inner_join(order_products_prior)
OrderProductPrior<-drop_na(OrderProductPrior)
OrderProductPrior<-OrderProductPrior[-c(3)]

#correlation matrix to find correlations in the data
corr_OrderProductPrior<-as.data.frame(cor(OrderProductPrior))

#plotting correlation matrix
ggcorrplot(corr_OrderProductPrior,hc.order = TRUE, type = "lower", outline.col = "purple", 
           ggtheme = theme_gray,lab = TRUE) + ggtitle("Correlation Matrix for OrderProductPrior")

```
### Linear Regression Model
An important part of the business is predicting how many of what products will be ordered at what hour. As Instacart is more of delivery service, it is important to know when the orders are coming as it may help different business decisions such as number of shoppers they will need at certain hours of certain days, also for market basket it is important to keep their shelves stocked up. 

```{r}
OrderProductPrior_lm<-orders%>%inner_join(order_products_prior)%>%inner_join(products)
OrderProductPrior_lm<-drop_na(OrderProductPrior_lm)
OrderProductPrior_lm<-OrderProductPrior_lm[-c(3)]
OrderProductPrior_lm
OrderHour_lm <- OrderProductPrior_lm[-c(1,2,7,10)]
```

```{r}
#Fitting Linear Model
OrderHour_lm <- lm(order_hour_of_day ~ order_number + order_dow + days_since_prior_order + add_to_cart_order + reordered + aisle_id + department_id, data = OrderHour_lm)
summary(OrderHour_lm)
```


### Linear Regression
```{r}
user <- OrderProductPrior_lm %>% 
  group_by(user_id) %>% 
  mutate(days_since_prior_order = as.numeric(days_since_prior_order)) %>%
  transmute(total_orders = n_distinct(order_id), avg_days_since_prior_order= mean(days_since_prior_order, na.rm = TRUE), avg_no_items = max(add_to_cart_order), reordered= reordered, order_day = order_dow, product_id=product_id)
user
reorder_log <- user[-c(1)]
reorder_log

```


```{r}
#Fitting a binary logistic regression
reorder_log <- glm(reordered ~., data = reorder_log, family = "binomial")
#Model summary
summary(reorder_log)
```

### Logistic Regression

Then we will be predicting the chances of a user reordering. As we know from our EDA, Instacart has a lot of loyal customers, who order bi-weekly or monthly. While ordering they also reorder a lot of the same products. So predicting whether a user will reorder or not, may help us later to understand what products to recommend while they are purchasing.

```{r}

OrderProductPrior_lm

model_train_data<-orders%>%inner_join(order_products_train)%>%inner_join(products)

model_train_data<-model_train_data%>%mutate(order_dow=as.factor(order_dow),order_hour_of_day=as.factor(order_hour_of_day),days_since_prior_order=as.factor(days_since_prior_order))
model_train_data<-model_train_data[-c(1:3)]
model <- glm(reordered ~.,family=binomial(link='logit'),data=model_train_data)

```


